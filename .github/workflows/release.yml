name: Build and Release EXE

# 配置触发条件
on:
  push:
    tags:
      - 'v*' # 只有当你推送类似 "v1.0.0" 的标签时，才会触发自动打包
  workflow_dispatch: # 允许你在 GitHub 网页上手动点击运行测试

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest # 使用最新的 Windows 环境进行打包

    steps:
    - name: 检出代码 (Checkout code)
      uses: actions/checkout@v4

    - name: 配置 Python 环境 (Set up Python)
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' # 建议与你本地开发使用的版本保持一致

    - name: 安装依赖库 (Install dependencies)
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: 使用 PyInstaller 打包生成 EXE (Build EXE)
      # 这里完全照搬了你 bat 脚本里的核心打包命令
      run: |
        pyinstaller --noconsole --onefile --name "AnomaSlice" main.py
        
    - name: 发布到 GitHub Releases (Create Release)
      uses: softprops/action-gh-release@v2
      # 仅在通过 Tag 触发时才创建 Release
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # 告诉 GitHub 提取 dist 文件夹下的 EXE 文件并挂载到 Release 中
        files: dist/AnomaSlice.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动提供的密钥，无需手动配置