# 工业视觉图像切分标注工具 (Industrial Image Slicer & Annotator)

工业视觉图像切分标注工具是一个基于 Python 的桌面 GUI 应用，主要用于工业质检（AOI）场景下的数据集制作。它通过网格化切分和交互式标注，帮助用户高效地将高分辨率工业图像切分为小图，并自动分类为 Normal（正常）和 Abnormal（缺陷）。

> **目标**：在尽量减少人工逐张分类工作的前提下，高效构建高质量的工业缺陷检测 / 分割数据集。

## 🎥 使用演示 (Demo)

<div align="center">
  <video src="demo.mp4" width="100%" controls autoplay loop muted></video>
  <br>
  <a href="demo.mp4">点击查看演示视频文件</a>
</div>

## ✨ 功能特性

### 1. 图像切分 (Image Slicing)
- **自定义尺寸**：支持将大图切分为固定尺寸的小图（可配置宽、高，如 256x256）。
- **步长控制 (Stride)**：支持设置步长，控制小图之间的重叠程度（Overlap）。
- **网格预览**：切分网格以叠加层的形式实时显示在原图上，方便预判切分效果。
- **智能网格**：支持双色虚线网格，适应不同背景亮度的图片。

### 2. 网格化标注与审查 (Grid Annotation & Review)
- **单元检视 (Unit Review)**：提供专门的“单元检视”模式，自动遍历每一个切分单元（Patch）。
- **快速分类**：用户只需对当前高亮显示的 Patch 点击“有缺陷”或“无缺陷”按钮（或使用快捷键），即可完成标注。
- **状态可视化**：已标注为“缺陷”的区域会在原图上以红色半透明矩形覆盖，直观展示缺陷分布。

### 3. 自动归类与保存 (Auto Classification)
- **后台切分**：点击“执行切分”后，后台线程自动根据用户的标注结果，将小图分别保存至 `Normal` 和 `Abnormal` 目录。
- **中文路径支持**：完整支持中文文件路径的读取和保存。

### 4. 工程管理 (Project Management)
- **进度保存**：支持将当前进度、配置参数、标注数据持久化保存为 JSON 工程文件 (`.json`)。
- **防止丢失**：避免因程序意外关闭或中断导致的工作丢失。

### 5. 结果预览 (Gallery)
- **实时查看**：切分完成后，右侧预览区会自动加载 Normal / Abnormal 文件夹中的图片。
- **懒加载**：支持缩略图懒加载，避免大量图片导致的内存溢出和界面卡顿。

## 🛠 技术栈

- **语言**：Python 3.12
- **GUI 框架**：PySide6 (Qt for Python)
- **图像处理**：OpenCV (cv2), NumPy
- **图像加载**：Pillow (PIL)
- **配置管理**：JSON

## 🚀 快速开始

### 1. 准备运行环境

建议使用 Conda 创建独立环境：

```bash
conda create -n AnomaSlice python=3.12
conda activate AnomaSlice
```

安装依赖：

```bash
pip install pyside6 opencv-python numpy pillow
```

### 2. 运行程序

在项目根目录下执行：

```bash
python main.py
```

或者直接运行 `dist` 目录下的可执行文件（如果有）：

```bash
./dist/AnomaSlice.exe
```

## 📖 基本使用流程

1. **新建/打开工程**：
   - 启动程序，点击“文件” -> “新建工程”或“打开工程”。
   - 设置**原始图片路径**、**Normal 输出路径**、**Abnormal 输出路径**。

2. **调整切分参数**：
   - 在左侧面板设置 **Patch Size** (宽/高) 和 **Stride** (步长)。
   - 观察原图上的网格预览，确保切分大小合适。

3. **标注与审查**：
   - 程序会自动进入“单元检视”模式，高亮显示第一个 Patch。
   - 观察中间下方的“单元检视”窗口，判断当前 Patch 是否有缺陷。
   - 点击 **“有缺陷”** (红色) 或 **“无缺陷”** (绿色) 按钮。
   - 程序会自动跳转到下一个 Patch，直至完成整张图的标注。
   - *提示：也可以直接在原图画布上点击某个网格来进行跳转或修改状态。*

4. **执行切分**：
   - 标注完成后，点击 **“Slice and Next”** (或按 Enter 键)。
   - 程序会在后台将切分好的图片保存到对应文件夹。
   - 保存完成后，自动清空画布并加载下一张原始图片（如果有）。

5. **结果检查**：
   - 右侧预览区会刷新显示刚刚切分出的图片，可双击查看大图。

## ⌨️ 快捷键

- `Ctrl + Z` / `Ctrl + Shift + Z`：撤销 / 重做
- `Ctrl + S`：保存工程
- `Ctrl + O`：打开工程
- `Enter` (Return)：执行切分并进入下一张图片 (Slice and Next)
- `Wheel` (滚轮)：缩放视图 (配合 Ctrl 键)

## 📂 项目结构

```
AnomaSlice/
├── main.py             # 程序入口与核心逻辑
├── dist/
│   ├── AnomaSlice.exe  # 可执行文件
├── README.md            # 项目说明文档
├── demo.mp4             # 使用演示视频
└── ...
```

## ⚠️ 注意事项

- **路径设置**：请确保输出目录（Normal/Abnormal）具有写入权限。
- **大图性能**：对于超大分辨率（如 10000x10000+）的图片，建议适当增大 Stride 以减少 Patch 数量，避免内存占用过高。
